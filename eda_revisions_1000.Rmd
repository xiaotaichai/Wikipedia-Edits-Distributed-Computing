---
title: "EDA of Revisions"
author: "Kevin, Fanny"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Combining Kevin's Readme with plotly interactive graphics  


# Load libraries  
```{r, message=FALSE, warning=FALSE}
library(data.table)
library(here)
library(tidyverse)
library(plotly)
library(janitor)
library(lubridate)
library(zoo)
```

# Use UNIX commands to clean file  
Replace `<<sep>>` with a special character.   
```{r}
# system("sed 's/<<sep>>/^/g' all_revisions_1000_articles.txt > all_revisions_1000_articles_caratseparated.txt")
# 
# cat(readLines("all_revisions_1000_articles_caratseparated.txt"), sep = "^")
```

# Read in data  
```{r, cache=TRUE}
all.revisions.1000.path <- here::here("all_revisions_1000_articles_caratseparated.txt")

revisions <- read.table(all.revisions.1000.path, 
                        sep = "^",
                        quote="",
                        header=FALSE,
                        stringsAsFactors = FALSE,
                        col.names = c("article_id", "rev_id", "article_title", "timestamp", "[ip:]username", "user_id", "CATEGORY", "IMAGE", "MAIN", "TALK", "USER", "USER_TALK", "OTHER", "EXTERNAL",
      "TEMPLATE", "COMMENT", "MINOR", "TEXTDATA"),
      fill=TRUE)



# colnames(revisions) <- c("article_id", "rev_id", "article_title", "timestamp", "[ip:]username", "user_id", "CATEGORY", "IMAGE", "MAIN", "TALK", "USER", "USER_TALK", "OTHER", "EXTERNAL",
#       "TEMPLATE", "COMMENT", "MINOR", "TEXTDATA")

```

# Clean data that we just read  
```{r}
revisions.processed <- revisions %>% 
  clean_names() %>% 
  mutate(timestamp = gsub("T", " ", timestamp)) %>% 
  mutate(timestamp = gsub("Z", "", timestamp)) %>% 
  mutate(timestamp = ymd_hms(timestamp)) %>% 
  mutate(year = year(timestamp)) %>% 
  mutate(month = month(timestamp)) %>% 
  mutate(year_month = as.yearmon(timestamp))
```

# Grab all categories for each article_id  
```{r}
categories <-  revisions.processed %>% 
  group_by(article_id) %>% 
  summarise(categories=paste(category, collapse = " "))

categories$categories <- sapply(strsplit(categories$categories, split=" "), function(x) {
  paste0(unique(trimws(x)), collapse = ', ')
})

tail(categories, 10)
```

Split up the categories listed within each row entry  
```{r}
categories.df <- as.data.frame(str_split_fixed(categories$categories, ", ", max(unlist(lapply(strsplit(categories$categories, ", "), length)))))

categories.df <- categories.df[,-1]
names(categories.df) <- paste0("category_", 1:ncol(categories.df))
categories.df <- cbind(article_id = categories$article_id, categories.df)
```

# Tidy up categories  
from wide to long format
replace empties with NA and filter them out
```{r}
categories.counts <- categories.df %>% 
  gather(category, categories, -article_id) %>%
  replace(. == "", NA) %>%
  filter(!is.na(categories)) %>%
  select(-category) %>%
  group_by(categories) %>%
  summarise(number = n()) %>%
  arrange(desc(number)) 
```


# Back to Working with Dates  

##create monthly counts  
```{r, cache=TRUE}
monthly.counts <- revisions.processed %>% 
  # select(article_id, year, month, year.mon) %>% 
  group_by(article_id, year_month) %>% 
  summarise(count = n())
  
arrange(monthly.counts, article_id, year_month)


p <- ggplot(data = monthly.counts, aes(x=year_month, y = count, colour = article_id)) + 
  geom_line(aes(group = article_id)) +
  geom_point() +
  ggtitle("Number of Article Revisons by Year & Month") +
  xlab("Year-Month")

p
ggsave("img/article-revisions-by-year-month.png", p)


ggplotly(p)
```
  
    
It could be interesting to look at which articles have such high amounts of revisions.

For now, let's normalize by total number of revisions to get percentages.
```{r}
percent.revisions <- monthly.counts %>%
  group_by(article_id) %>%
  mutate(percent = count/sum(count))

p <- ggplot(data = percent.revisions, aes(x=year_month, y = percent, colour = article_id)) + 
  geom_line(aes(group = article_id)) + 
  geom_point() +
  xlab("Year-Month") +
  ggtitle("Revisions Per Year-Month Normalized by Total Revisions")

p

ggplotly(p)
```



Plot this with first revision to get plot to prove our point about article ids and article age.  


Looks like articles that were created after 2006, might not have had time to show true trends of the lifecycle of the article. Let's only look at records that were first edited before 2006.  


# First Revision Date for Articles First Edited Before 2006  

When was the Wiki page first revised? That information will help inform us about the behavior of a page relative to other pages created at different times.  

Plot this with first revision to get plot to prove our point about article ids and article age.  

Looks like articles that were created after 2006, might not have had time to show true trends of the lifecycle of the article. Let's only look at records that were first edited before 2006. 

this won't work if the data isn't sorted by date
need date of first revision for each article id  


For each id, obtain the first time it was edited.  

```{r}
articles.before.2006 <- percent.revisions %>% 
  mutate(year_month = as.Date(year_month, format='%b %y')) %>% 
  group_by(article_id) %>%
  summarize(first_revis_date = min(year_month))
```



<!-- ```{r} -->
<!-- t.first <- percents[!duplicated(percents$article_id),] -->
<!-- arrange(t.first, desc(date)) -->
<!-- t.first.before2003 <- subset(t.first, as.yearmon(date) < as.yearmon("2003-01")) -->
<!-- arrange(t.first.before2003, desc(date)) -->
<!-- ``` -->


<!-- So now we know which article_id's were created before 2006. -->
<!-- We need to subset the data for these article_ids -->
<!-- ```{r} -->
<!-- filtered_revisions <- percents[percents$article_id %in% t.first.before2003$article_id, ] -->
<!-- arrange(filtered_revisions, article_id) -->
<!-- ggplot(data = filtered_revisions, aes(x=as.yearmon(date), y = percent, colour = article_id)) + geom_line(aes(group = article_id)) + geom_vline(xintercept = as.yearmon("2003-01"), colour = "red") + geom_point() -->
<!-- ggplot(data = filtered_revisions, aes(x=as.yearmon(date), y = percent, colour = article_id)) + geom_line(aes(group = article_id)) + geom_vline(xintercept = as.yearmon("2003-01"), colour = "red") + ylim(0,.5) + geom_point() -->
<!-- ``` -->




